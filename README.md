# Zapret Discord + YouTube для macOS

Единая обёртка над [zapret](https://github.com/bol-van/zapret) для macOS: обход блокировок **только** для Discord и YouTube. Аналог [zapret-discord-youtube](https://github.com/Flowseal/zapret-discord-youtube) (Windows), но для Mac.

---

## Быстрый старт

1. **Один скрипт с нуля:** дважды нажмите **`service.command`** → выберите `1. Установить и запустить`.
2. Введите пароль администратора, дождитесь установки.
3. Всё настроится автоматически:
   - на macOS Sonoma 14.5+ будет использован режим **SOCKS** и включён системный прокси;
   - на более старых версиях — прозрачный режим без прокси.

Либо в терминале:
```bash
cd ~/zapret-discord-youtube-macos
./service.command install
```

---

## Файлы

| Файл | Назначение |
|------|------------|
| **service.command** | Главный скрипт — интерактивное меню: установка, запуск, остановка, обновление списков, стратегии и т.д. |
| **config.conf** | Единый конфиг: режим (auto/transparent/socks), стратегия, порт, автопрокси. |
| **Install.command** | Установка с нуля (то же, что пункт 1 в меню или `service.command install`). |
| **Switch-Strategy.command** | Смена стратегии 1–13 (то же, что пункт 6 в меню). |
| **lists/domains.txt** | Список доменов для обхода. По умолчанию — Discord и YouTube. |
| **utils/strategies/strategies.json** | Описания стратегий (номера, названия) для меню. |
| **utils/block-quic.sh** | Блокировка QUIC (UDP/443) в прозрачном режиме. |
| **utils/update-discord-hosts.sh** | Обновление блока Discord в `/etc/hosts`. |
| **utils/check-availability.sh** | Проверка доступности YouTube и Discord (пункт 8, `service.command check`). |

---

## config.conf

```ini
# Режим: auto | transparent | socks
MODE=auto

# Стратегия (1–13), для прозрачного режима; 11 — ALT11 (рекомендуется)
STRATEGY=11

# Системный SOCKS-прокси при start/stop (только для режима SOCKS)
AUTO_SYSTEM_PROXY=1

# Блокировать QUIC (UDP/443) для IP из списка — только в прозрачном режиме
BLOCK_QUIC=1

# После смены стратегии проверять доступность YouTube и Discord
TEST_AFTER_STRATEGY=1

# Файл доменов, порт SOCKS
DOMAINS_FILE=lists/domains.txt
SOCKS_PORT=987
```

---

## Режимы

- **Прозрачный** — трафик перенаправляется через PF, прокси вручную не нужен. На Sonoma 14.5+ **не работает** (ограничения ядра).
- **SOCKS** — локальный прокси 127.0.0.1:987. При `AUTO_SYSTEM_PROXY=1` скрипт сам включает/выключает системный прокси при `start`/`stop`.

---

## Добавить домен

Откройте `lists/domains.txt`, добавьте домен (один на строку), сохраните. Затем: `service.command update` или пункт 5 в меню.

---

## Дополнительные опции

- **Блокировка QUIC** — в прозрачном режиме при `BLOCK_QUIC=1` (по умолчанию) трафик UDP/443 к списку zapret блокируется, чтобы YouTube/Discord шли по TCP через tpws. В SOCKS-режиме не используется.
- **Обновить hosts для Discord** — пункт меню 7 или `./service.command discord-hosts`. Резолвит Discord-домены из `lists/domains.txt` и обновляет блок в `/etc/hosts` (между маркерами `# >>> zapret-discord-youtube-macos discord` и `# <<< ...`). Может помочь с голосом и обновлениями клиента.
- **Проверка после смены стратегии** — при `TEST_AFTER_STRATEGY=1` после смены стратегии выполняется быстрая проверка (curl) YouTube и Discord; результат выводится в консоль.
- **Проверить доступность** — пункт меню 8 или `./service.command check`. В любой момент проверяет ответ YouTube и Discord (через прокси, если zapret в SOCKS-режиме запущен, иначе напрямую). Не меняет настройки.
- **Стратегии из JSON** — список стратегий в меню и в `Switch-Strategy.command` берётся из `utils/strategies/strategies.json` (номера и описания). Опции tpws по-прежнему в `utils/strategies/N-*.txt`.

---

## Удаление

1. `./service.command stop`
2. Удалить папку `zapret-discord-youtube-macos`
3. Полное удаление zapret:
   ```bash
   sudo /opt/zapret/init.d/macos/zapret stop
   sudo /opt/zapret/uninstall_easy.sh
   ```

---

## Требования

- macOS, Xcode Command Line Tools
- Права администратора (для установки и start/stop)

---

## DNS и DPI: когда zapret нужен, а когда нет

Блокировки бывают **на уровне DNS** (провайдер подсовывает «заблокированную» страницу или не даёт резолвить домен) и **на уровне DPI** (глубокий анализ пакетов по SNI и т.п., режет уже установленные соединения).

- **Если YouTube/Discord открываются при смене DNS** (например, Google DNS 8.8.8.8 / 8.8.4.4 или Cloudflare 1.1.1.1) **без zapret** — у вас, скорее всего, блокировка по DNS. В этом случае zapret не обязателен: достаточно настроить нужный DNS в Wi‑Fi (Системные настройки → Сеть → Wi‑Fi → Подробнее → DNS).
- **Zapret нужен**, когда DNS уже «нормальный», но сайт всё равно не открывается или обрывается — типично обход DPI (подмена/фрагментация пакетов и т.д.).

**Почему «пропадает весь интернет», когда zapret запущен:** В режиме SOCKS системный прокси направляет **весь** трафик приложений в локальный прокси (tpws). Если что-то идёт не так (задержки, таймауты, сбой в tpws), может казаться, что «ничего не работает». Рекомендуется: перед включением zapret проверить, что без него интернет стабилен; при проблемах — остановить zapret (пункт 3) и убедиться, что доступ восстановился. На некоторых сетях достаточно DNS без zapret.

**Итог:** инструмент не «нерабочий» — он решает задачу обхода DPI. Если у вас блокировка в основном по DNS и вы уже решили её сменой DNS, zapret может не давать заметной пользы для YouTube, но может пригодиться для Discord или других сайтов, где режут по DPI.

---

## Прокси тормозит: что сделать

Прокси локальный (tpws), но через него при системном прокси идёт **весь** трафик всех приложений, плюс обход DPI добавляет работу на каждое соединение. Отсюда задержки и «подвисания».

**Что можно сделать:**

1. **Гнать через прокси только браузер**  
   В `config.conf` поставьте **`AUTO_SYSTEM_PROXY=0`**. После запуска zapret (пункт 2) системный прокси не включится. Вручную укажите прокси только в браузере: **Системные настройки → Сеть → Wi‑Fi → Подробнее → Прокси** или в настройках Chrome/Safari — сервер `127.0.0.1`, порт `987` (или ваш `SOCKS_PORT`). Тогда через tpws пойдёт только браузер (YouTube, Discord в браузере), а почта, мессенджеры и т.д. — напрямую. Нагрузка на прокси и «тормоза» обычно уменьшаются.

2. **Более простая стратегия**  
   Стратегии с меньшим числом правил меньше нагружают CPU. Попробуйте **5 (simple)** или **1 (default)** — пункт 6 в меню. Если обход сохраняется, оставьте их; если сайты перестанут открываться — верните 11 или 12.

3. **Включать zapret только когда нужен**  
   Запускайте (пункт 2), когда идёте в Discord/YouTube; останавливайте (пункт 3), когда не пользуетесь ими — тогда весь трафик идёт напрямую без прокси.

Саму программу tpws мы не меняем (она из upstream zapret), поэтому ускорять её из этой обёртки нельзя; можно только уменьшить объём трафика через неё и нагрузку (п. 1 и 2).

---

## Zapret2 и возможные улучшения

### Zapret vs Zapret2

Автор [bol-van](https://github.com/bol-van) развивает **[zapret2](https://github.com/bol-van/zapret2)** как актуальную версию; первая версия (zapret / nfqws1) больше не поддерживается. В zapret2 стратегии обхода пишутся на **Lua** (гибко, без пересборки C), есть отдельные пресеты под Discord и YouTube (в т.ч. для Windows). Поддерживаются Linux (nftables), FreeBSD/OpenBSD (pf, ipfw), Windows (WinDivert). **На macOS** в репозитории zapret2 нет готового init.d/обвязки под PF и tpws — там по умолчанию ориентир на nfqws2 (перехват через nftables/ipfw/pf в стиле Linux/BSD). Поэтому текущая обёртка опирается на классический [zapret](https://github.com/bol-van/zapret) с **tpws + PF**, что на macOS реально доступно и работает.

### Реализованные идеи (в т.ч. из zapret-macos-easy)

В проекте уже сделано:

- **Блокировка QUIC (UDP/443)** — в прозрачном режиме при старте загружается PF-anchor `zapret_quic`, блокирующий UDP/443 до IP из списка zapret. Включается опцией `BLOCK_QUIC=1` в `config.conf`.
- **Обновление hosts для Discord** — пункт меню 7 и команда `./service.command discord-hosts`; скрипт `utils/update-discord-hosts.sh` обновляет блок в `/etc/hosts` между маркерами.
- **Стратегии из JSON** — `utils/strategies/strategies.json` задаёт описания стратегий; меню и `Switch-Strategy.command` выводят список по нему.
- **Проверка после смены стратегии** — при `TEST_AFTER_STRATEGY=1` после смены стратегии выполняется проверка доступности YouTube и Discord (curl через прокси или напрямую).

Дальнейшее развитие возможно за счёт новых стратегий в Lua (zapret2), когда для macOS появится поддержка nfqws2.
